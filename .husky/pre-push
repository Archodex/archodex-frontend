#!/bin/bash

# Pre-push hook to run GitHub Actions workflows that would trigger on PR to main
# Specifically runs the pr-lint-and-type-check.yml workflow
set -e

echo "ğŸš€ Running GitHub Actions workflows before push..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Check if act is installed
if ! command -v act &> /dev/null; then
    print_error "act is not installed. Please install it first:"
    echo "  brew install act  # macOS"
    echo "  https://github.com/nektos/act#installation"
    exit 1
fi

# Get current branch name
current_branch=$(git branch --show-current)
print_status "Current branch: $current_branch"

print_status "Simulating PR from $current_branch to main..."

print_status "Running workflows that trigger on pull_request_target to main..."

# Create a temporary event file for act with the correct head sha
event_file=$(mktemp)
cat > "$event_file" <<EOF
{
    "pull_request": {
        "head": {
            "sha": "$(git rev-parse "$current_branch")",
            "ref": "$current_branch"
        },
        "base": {
            "ref": "main"
        }
    },
    "repository": {
        "full_name": "$(git config --get remote.origin.url | sed -E 's/.*[:\/](.+\/.+)\.git/\1/')"
    }
}
EOF

if act pull_request \
     --platform ubuntu-latest=catthehacker/ubuntu:act-latest \
     --artifact-server-path /tmp/artifacts; then
        print_status "âœ… All PR-triggered workflows completed successfully"
        rm -f "$event_file"
else
    print_error "âŒ One or more PR-triggered workflows failed"
    print_error "PR workflows failed. Push aborted."
    rm -f "$event_file"
    exit 1
fi

print_status "ğŸ‰ All PR-triggered workflows completed successfully! Proceeding with push..."

exit 0